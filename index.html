<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Olimpic de T√®cnica Comptable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .t-account { min-width: 140px; }
        .line-vertical { width: 2px; background-color: #e2e8f0; }
        .animate-medal { animation: scale-up 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes scale-up { from { transform: scale(0); } to { transform: scale(1.5); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">

    <div class="flex h-screen overflow-hidden">
        <aside class="w-72 bg-slate-900 text-white p-6 flex flex-col shadow-2xl">
            <div class="mb-10">
                <h1 class="text-2xl font-extrabold tracking-tight text-indigo-400">OLIMPIC<span class="text-white">CONTABLE</span></h1>
                <p class="text-xs text-slate-400 mt-1 uppercase tracking-widest font-semibold">Base de Dades: Google Sheets</p>
            </div>
            
            <nav id="menu-temes" class="flex-1 space-y-2 overflow-y-auto">
                <div class="animate-pulse bg-slate-800 h-10 rounded-lg"></div>
            </nav>

            <div class="mt-auto p-4 bg-slate-800 rounded-xl">
                <p class="text-xs text-slate-400 uppercase font-bold">Grup seleccionat</p>
                <div class="flex items-center gap-3 mt-2">
                    <span class="text-2xl">üé≠</span>
                    <span id="grup-nom" class="font-semibold text-sm">Carregant...</span>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-y-auto">
            <header class="h-20 bg-white border-b border-slate-200 px-8 flex justify-between items-center sticky top-0 z-10">
                <div class="flex gap-8">
                    <div class="text-center"><p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Respostes</p><p id="stats-total" class="font-bold text-lg">0</p></div>
                    <div class="text-center"><p class="text-[10px] text-emerald-500 font-bold uppercase tracking-tighter">Correctes</p><p id="stats-ok" class="font-bold text-lg text-emerald-600">0</p></div>
                </div>
                <div id="status-api" class="flex items-center gap-2 text-xs font-medium text-amber-500 bg-amber-50 px-3 py-1 rounded-full">
                    <span class="w-2 h-2 bg-amber-500 rounded-full animate-ping"></span> Connectant a Google Sheets...
                </div>
            </header>

            <section class="p-8 max-w-6xl mx-auto w-full space-y-8">
                
                <div class="bg-white rounded-3xl shadow-xl shadow-slate-200/50 p-10 border border-slate-100 transition-all">
                    <div class="flex justify-between items-start mb-6">
                        <span id="label-tema" class="px-4 py-1 bg-indigo-50 text-indigo-600 rounded-full text-xs font-bold uppercase tracking-widest">Tema 1: Vendes</span>
                        <div id="medalla-display" class="hidden text-5xl animate-medal">ü•á</div>
                    </div>
                    
                    <h2 id="enunciat" class="text-3xl font-semibold text-slate-800 mb-8 leading-snug">
                        Quin √©s l'assentament comptable en una venda de mercaderia al comptat de 2.000‚Ç¨ + 21% IVA?
                    </h2>

                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div class="bg-emerald-50/30 rounded-2xl p-6 border-2 border-dashed border-emerald-200 min-h-[250px]">
                            <h3 class="text-emerald-700 font-black text-xs tracking-[0.2em] mb-4">DEURE (APLICACI√ì)</h3>
                            <div id="rows-deure" class="space-y-3"></div>
                        </div>
                        <div class="bg-sky-50/30 rounded-2xl p-6 border-2 border-dashed border-sky-200 min-h-[250px]">
                            <h3 class="text-sky-700 font-black text-xs tracking-[0.2em] mb-4">HAVER (ORIGEN)</h3>
                            <div id="rows-haver" class="space-y-3"></div>
                        </div>
                    </div>

                    <div class="relative group">
                        <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-slate-400">üîç</div>
                        <input type="text" id="cercador-pgc" onkeyup="buscarCompte(event)" 
                               class="w-full bg-slate-100 border-none rounded-2xl py-4 pl-12 pr-4 focus:ring-4 focus:ring-indigo-100 transition-all font-medium" 
                               placeholder="Escriu el nom o codi del compte (ex: 570)...">
                        
                        <div id="dropdown-res" class="absolute top-full left-0 right-0 mt-2 bg-white shadow-2xl rounded-2xl border border-slate-100 hidden z-50 overflow-hidden"></div>
                    </div>

                    <div class="flex gap-4 mt-8">
                        <button onclick="validarResposta()" class="flex-1 bg-slate-900 text-white py-5 rounded-2xl font-extrabold tracking-wide hover:bg-indigo-600 transition-all shadow-lg shadow-indigo-100 active:scale-95">
                            CONFIRMAR ASSENTAMENT
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <h3 class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mb-4">Llibre Major (T's Actualitzades)</h3>
                        <div id="majors-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            </div>
                    </div>
                    
                    <div>
                        <h3 class="text-slate-400 font-bold uppercase text-[10px] tracking-widest mb-4">Esquema Patrimonial</h3>
                        <div id="balanc-esquema" class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm space-y-4">
                            
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/.../exec'; // Posa aqu√≠ la teva URL d'Apps Script
        let pgcData = [];
        let preguntesData = [];
        let indexPregunta = 0;
        let assentamentAlumne = { deure: [], haver: [] };

        // 1. Carregar dades inicials
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`${API_URL}?action=getDades`);
                const data = await response.json();
                pgcData = data.pgc;
                preguntesData = data.preguntes;
                initGame();
                document.getElementById('status-api').innerHTML = 'üü¢ Connectat a Google Sheets';
                document.getElementById('status-api').className = 'flex items-center gap-2 text-xs font-medium text-emerald-500 bg-emerald-50 px-3 py-1 rounded-full';
            } catch (e) {
                console.error("Error API:", e);
            }
        });

        function initGame() {
            carregarPregunta(0);
            renderMenu();
        }

        function renderMenu() {
            const menu = document.getElementById('menu-temes');
            const temes = [...new Set(preguntesData.map(p => p.tema))];
            menu.innerHTML = temes.map((t, i) => `
                <button onclick="carregarPreguntaPerTema('${t}')" class="w-full text-left p-3 rounded-xl hover:bg-slate-800 transition text-sm font-semibold">
                    ${i+1}. ${t}
                </button>
            `).join('');
        }

        function buscarCompte(e) {
            const query = e.target.value.toLowerCase();
            const resBox = document.getElementById('dropdown-res');
            if(query.length < 2) { resBox.classList.add('hidden'); return; }

            const filtrats = pgcData.filter(c => c.codi.includes(query) || c.nom.toLowerCase().includes(query)).slice(0, 6);
            resBox.innerHTML = filtrats.map(c => `
                <div class="p-4 hover:bg-slate-50 cursor-pointer flex justify-between border-b border-slate-50" onclick="prepararAfegir('${c.codi}', '${c.nom}')">
                    <span class="font-bold text-indigo-600">${c.codi}</span>
                    <span class="text-slate-600 font-medium">${c.nom}</span>
                </div>
            `).join('');
            resBox.classList.remove('hidden');
        }

        function prepararAfegir(codi, nom) {
            const importInput = prompt(`Introdueix l'import per al compte ${codi} - ${nom}:`);
            if(!importInput || isNaN(importInput)) return;
            
            const costat = confirm(`Vols posar-lo al DEURE? (Prem Cancel¬∑lar per al HAVER)`) ? 'deure' : 'haver';
            
            assentamentAlumne[costat].push({ codi, nom, import: parseFloat(importInput) });
            document.getElementById('dropdown-res').classList.add('hidden');
            document.getElementById('cercador-pgc').value = '';
            
            actualitzarVisuals();
        }

        function actualitzarVisuals() {
            // Actualitzar llistes Deure/Haver
            ['deure', 'haver'].forEach(side => {
                document.getElementById(`rows-${side}`).innerHTML = assentamentAlumne[side].map(item => `
                    <div class="flex justify-between items-center bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                        <span class="text-xs font-bold">${item.codi}</span>
                        <span class="text-xs flex-1 px-2 truncate">${item.nom}</span>
                        <span class="font-mono font-bold">${item.import.toFixed(2)}‚Ç¨</span>
                    </div>
                `).join('');
            });

            // Punt 5: Actualitzar Majors en T
            renderMajors();
        }

        function renderMajors() {
            const grid = document.getElementById('majors-grid');
            const totsElsComptes = [...new Set([...assentamentAlumne.deure, ...assentamentAlumne.haver].map(c => c.codi))];
            
            grid.innerHTML = totsElsComptes.map(codi => {
                const movsD = assentamentAlumne.deure.filter(x => x.codi === codi);
                const movsH = assentamentAlumne.haver.filter(x => x.codi === codi);
                return `
                    <div class="bg-white border border-slate-200 rounded-lg overflow-hidden t-account shadow-sm">
                        <div class="bg-slate-50 p-1 text-[8px] font-black text-center uppercase border-b">${codi}</div>
                        <div class="flex">
                            <div class="flex-1 p-2 text-[10px] text-emerald-600 font-mono text-right border-r border-slate-100">${movsD.map(m => `<div>${m.import}</div>`).join('')}</div>
                            <div class="flex-1 p-2 text-[10px] text-sky-600 font-mono">${movsH.map(m => `<div>${m.import}</div>`).join('')}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Punt 6: Validaci√≥ amb medalla
        function validarResposta() {
            const solucio = preguntesData[indexPregunta].solucio;
            // L√≤gica de verificaci√≥ simplificada
            const esCorrecte = verificarAssentament(solucio, assentamentAlumne);
            
            if(esCorrecte) {
                document.getElementById('medalla-display').classList.remove('hidden');
                alert("ü•á CORRECTE! +1 PUNT\n\nExplicaci√≥: " + preguntesData[indexPregunta].explicacio);
            } else {
                alert("‚ùå Hi ha algun error en l'assentament o no quadra.");
            }
        }

        function verificarAssentament(sol, user) {
            // Comprovar si els imports totals quadren (Partida Doble)
            const sumD = user.deure.reduce((a, b) => a + b.import, 0);
            const sumH = user.haver.reduce((a, b) => a + b.import, 0);
            return sumD === sumH && sumD > 0;
        }
    </script>
</body>
</html>